---
title: "Bias sensitivity simulation"
output: word_document
date: "2025-10-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Effect of bias due to immigration - Simulation

In order to investigate the relative magnitude of the bias potential due to immigration, a Monte Carlo simulation was employed assuming the following:

* The true abundance was equal to the abundance estimated for the smaller (600-649mm FL) size stratum.

* Sample sizes were equal to those corresponding to the smaller size stratum.

* The fraction migrating from the CROA to the MLSA was assumed to be 70%; that is, 70% of the fish subject to capture in the first event would be subject to capture in the second event.

* The MLSA (second-event) abundance was inflated by some number of fish that were not subject to capture in the first event.  A sequence of values were considered, and defined relative to the number of fish subject to capture in both events.  For example, if 7,000 fish were subject to capture in both events, a trial inflation value of 10% would imply that there were an extra 700 fish present, for a total true abundance of 7,700.

```{r}
nsim <- 10000# number of simulations to run for each p_res
```

Results are plotted below, showing the range of abundances estimated for `r format(nsim, big.mark = ",")` simulations.  It is immediately apparent that abundance estimates will be germane to the first event, but biased by the same relative amount that abundance was inflated in the second event.  For example, if 10,000 fish were present in the CROA in the first event, 7,000 of these were present in the MLSA in the second event, and an additional 10% (700) were also present in the MLSA, the expected value of the abundance estimate would be 11,000.  It is worth noting that the magnitude of this bias is actually relatively small with respect to the sampling variance of the estimate itself.

```{r, message=FALSE, warning=FALSE, fig.height=5, fig.width=7.5}
# ```{r, message=FALSE, warning=FALSE, fig.height=7.5, fig.width=4.5}

par(family="serif")
parmar <- par("mar")
par(mar=c(4,4,.5,1.5))

library(recapr)
library(jagshelper)


# n1 <- table(mr600_strat$input_data$event1$FL_strat)
# n2 <- table(mr600_strat$input_data$event2$FL_strat)
# m2_1 <- table(mr600_strat$recaps$matched$FL_strat_event1)
# m2_2 <- table(mr600_strat$recaps$matched$FL_strat_event2)

# Nhat_vec <- NChapman(n1, n2, m2_1)

# assumed values
N_croa <- 8042 # Nhat_vec[1]  # 24653  # 10*1000   # abundance at the CROA in winter
p_mlsa <- 0.7       # fraction of CROA that migrate to MLSA for summer

n1 <- 543 # n1[1] # 1049  # 1000  # sample sizes in both events
n2 <- 206 # n2[1] # 586   # 1000

N_mig <- N_croa*p_mlsa   # abundance at MLSA that migrated from CROA

p_res <- seq(from=0, to=1, by=0.05)  # factor by which MLSA abundance is "inflated"
                                     # by resident fish

Nhat <- matrix(nrow=nsim, ncol=length(p_res)) # initialize matrix for sim results

# loop over each value of p_res considered
for(i_p in seq_along(p_res)) {
  N_res <- N_mig*p_res[i_p]   # abundance of resident (non-migratory) MLSA fish
  N_mlsa <- N_mig + N_res     # abundance at MLSA (migratory and resident fish)
  
  # define fate vectors (each element is a fish)
  croa <- c(rep(TRUE, N_croa),  # fish at CROA in March
            rep(FALSE, N_res))  # fish not at CROA in March
  mlsa <- c(rep(TRUE, N_mig),            # CROA fish that migrated to MLSA
            rep(FALSE, N_croa - N_mig),  # CROA fish that did not migrate
            rep(TRUE, N_res))            # resident fish at MLSA
  
  # simulate sampling
  for(i_sim in 1:nsim) {
    sample1 <- sample(which(croa), n1)
    sample2 <- sample(which(mlsa), n2)
    recaps <- intersect(sample1, sample2)
    m2 <- length(recaps)
    
    Nhat[i_sim, i_p] <- NChapman(n1, n2, m2)   # from recapr package
  }
}

# par(mfrow=c(2,1))
par(mfrow=c(1,2))

# from jagshelper package
caterpillar(Nhat, x=p_res, mean=TRUE,
            xlab="MLSA inflation factor", ylab="Est Abundance",
            # ylim=c(5000, 40000),
            col=1)
abline(h=N_croa, lty=3)
abline(N_croa, N_croa, lty=2)
legend("topleft", 
       legend=c("sim estimates", "true abundance (1st event)", "theoretical"),
       lwd=c(3, 1, 1), pch=c(16, NA, NA), col=c(1, 1, 1), lty=c(1, 3, 2))

caterpillar((Nhat-N_croa)/N_croa, x=p_res, mean=TRUE,
            xlab="MLSA inflation factor", ylab="Relative bias (prop)",
            # ylim=c(-0.5, 4),
            col=1)
abline(h=0, lty=3)
abline(0, 1, lty=2)
legend("topleft", legend=c("rel bias of sims", "(no bias)", "theoretical bias"),
       lwd=c(3, 1, 1), pch=c(16, NA, NA), col=c(1, 1, 1), lty=c(1, 3, 2))

```

figure caption something like:

Simulated abundance estimates under a sequence of bias-generating scenarios (`r format(nsim, big.mark=',')` replications).  The heavy and light vertical bars represent 50% and 95% intervals, respectively.  Filled circles represent mean simulated values, which serve as approximations of expected values.  The dotted line represents the unbiased case, and the dashed line represents the case in which the relative bias is equal to the second-event inflation factor, as described previously.
